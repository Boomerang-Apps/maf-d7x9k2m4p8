{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://airview.dev/schemas/ai-story.v4.json",
  "title": "AI Development Story Schema V4",
  "description": "Schema for validating AI agent development stories in multi-agent systems. Merged from V10.7 traceability + AI Stories V1.",
  "version": "4.0.0",
  "type": "object",
  "required": [
    "id",
    "title",
    "domain",
    "acceptance_criteria",
    "files",
    "safety"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[A-Z]+-[A-Z]+-[0-9]{3}$",
      "description": "Story ID in format DOMAIN-TYPE-SEQ (e.g., AUTH-FE-001)",
      "examples": ["AUTH-FE-001", "PAYMENT-BE-003", "CLIENT-QA-012"]
    },
    "title": {
      "type": "string",
      "minLength": 10,
      "maxLength": 100,
      "pattern": "^(Create|Add|Update|Fix|Remove|Implement|Configure|Enable|Disable|Refactor|Migrate|Build|Setup|Initialize|Delete|Modify)",
      "description": "Action-oriented title starting with verb",
      "examples": [
        "Create LoginForm component with email validation",
        "Add rate limiting to authentication endpoint"
      ]
    },
    "domain": {
      "type": "string",
      "enum": [
        "auth",
        "layout",
        "core",
        "client",
        "pilot",
        "project",
        "proposal",
        "payment",
        "deliverables",
        "messaging",
        "admin",
        "notifications"
      ],
      "description": "Domain ownership for file access control (12 business domains)"
    },
    "agent": {
      "type": "string",
      "pattern": "^(fe|be|qa)-[a-z]+(-[a-z]+)?$",
      "description": "Agent ID in format type-domain (e.g., fe-auth, be-payment, qa-core)",
      "examples": ["fe-auth", "be-payment", "qa-core", "fe-client"]
    },
    "priority": {
      "type": "string",
      "enum": ["P0-Critical", "P1-High", "P2-Medium", "P3-Low"],
      "default": "P2-Medium",
      "description": "Story priority level"
    },
    "complexity": {
      "type": "string",
      "enum": ["S", "M", "L", "XL"],
      "description": "Story complexity: S(1-2hrs), M(2-4hrs), L(4-8hrs), XL(8+hrs)"
    },
    "wave": {
      "type": "integer",
      "minimum": 1,
      "description": "Execution wave number for parallel scheduling"
    },
    "estimate_hours": {
      "type": "number",
      "minimum": 0.5,
      "maximum": 16,
      "description": "Estimated hours for completion"
    },
    "objective": {
      "type": "object",
      "description": "User story format objective (required for clarity)",
      "required": ["as_a", "i_want", "so_that"],
      "properties": {
        "as_a": {
          "type": "string",
          "minLength": 5,
          "description": "User persona",
          "examples": ["registered user", "system administrator", "pilot"]
        },
        "i_want": {
          "type": "string",
          "minLength": 10,
          "description": "Desired capability",
          "examples": ["to log in with my email and password"]
        },
        "so_that": {
          "type": "string",
          "minLength": 10,
          "description": "Business benefit",
          "examples": ["I can access my personalized dashboard"]
        }
      }
    },
    "scope": {
      "type": "object",
      "description": "Explicit scope boundaries to prevent scope creep",
      "required": ["in_scope", "out_of_scope"],
      "properties": {
        "in_scope": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Items explicitly included"
        },
        "out_of_scope": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Items explicitly excluded"
        },
        "definitions": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Term definitions for clarity"
        }
      }
    },
    "acceptance_criteria": {
      "type": "array",
      "minItems": 3,
      "description": "EARS-format acceptance criteria with measurable thresholds",
      "items": {
        "type": "object",
        "required": ["id", "criterion"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^AC-[0-9]+$",
            "description": "Criterion ID (e.g., AC-1)"
          },
          "title": {
            "type": "string",
            "description": "Short title for the criterion"
          },
          "ears_pattern": {
            "type": "string",
            "enum": ["ubiquitous", "event-driven", "state-driven", "unwanted", "complex"],
            "description": "EARS pattern type"
          },
          "criterion": {
            "type": "string",
            "description": "Full EARS criterion text"
          },
          "given": {
            "type": "string",
            "description": "Precondition/context"
          },
          "when": {
            "type": "string",
            "description": "Trigger event"
          },
          "then": {
            "type": "string",
            "pattern": "(SHALL|SHOULD|MAY|MUST)",
            "description": "Expected behavior (must contain SHALL/SHOULD/MAY/MUST)"
          },
          "threshold": {
            "type": "string",
            "description": "Measurable threshold value (e.g., 'within 200ms', '>=80%')"
          }
        }
      }
    },
    "files": {
      "type": "object",
      "required": ["create", "forbidden"],
      "properties": {
        "create": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^(src|app|lib|tests|prisma|contracts|public|supabase)/"
          },
          "description": "Files to create (must be within allowed paths)"
        },
        "modify": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files to modify (can include line ranges)"
        },
        "forbidden": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Files that must NOT be touched (required for safety)"
        }
      }
    },
    "api_contract": {
      "type": "object",
      "description": "API endpoint specification (for backend stories)",
      "properties": {
        "endpoint": {
          "type": "string",
          "pattern": "^(GET|POST|PUT|PATCH|DELETE) /",
          "description": "HTTP method and path"
        },
        "request": {
          "type": "object",
          "properties": {
            "type_name": { "type": "string" },
            "fields": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "type": { "type": "string" },
                  "required": { "type": "boolean" },
                  "validation": { "type": "string" }
                }
              }
            }
          }
        },
        "response": {
          "type": "object",
          "properties": {
            "success_type": { "type": "string" },
            "error_codes": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "code": { "type": "string" },
                  "status": { "type": "integer" },
                  "message": { "type": "string" }
                }
              }
            }
          }
        }
      }
    },
    "tests": {
      "type": "object",
      "required": ["commands"],
      "properties": {
        "commands": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" },
          "description": "Test execution commands"
        },
        "coverage_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "default": 80,
          "description": "Minimum coverage percentage"
        },
        "unit_tests": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Unit test case descriptions"
        },
        "integration_tests": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Integration test case descriptions"
        }
      }
    },
    "dependencies": {
      "type": "object",
      "properties": {
        "stories": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]+-[A-Z]+-[0-9]{3}$"
          },
          "description": "Story IDs that must complete first"
        },
        "contracts": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Contract names that must exist"
        },
        "infrastructure": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Infrastructure requirements"
        }
      }
    },
    "safety": {
      "type": "object",
      "required": ["stop_conditions"],
      "properties": {
        "max_iterations": {
          "type": "integer",
          "minimum": 5,
          "maximum": 50,
          "default": 25,
          "description": "Maximum agent iterations before forced stop"
        },
        "token_budget": {
          "type": "integer",
          "minimum": 10000,
          "maximum": 500000,
          "default": 200000,
          "description": "Maximum tokens for this story"
        },
        "timeout_minutes": {
          "type": "integer",
          "minimum": 10,
          "maximum": 480,
          "default": 120,
          "description": "Maximum execution time in minutes"
        },
        "stop_conditions": {
          "type": "array",
          "minItems": 3,
          "items": { "type": "string" },
          "description": "Conditions that should trigger agent stop (minimum 3 required)"
        },
        "escalation_triggers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Conditions requiring human intervention"
        },
        "forbidden_operations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Operations the agent must never perform"
        }
      }
    },
    "implementation_hints": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Hints for the implementing agent"
    },
    "rollback_plan": {
      "type": "object",
      "properties": {
        "git_strategy": { 
          "type": "string",
          "description": "Git rollback approach (e.g., 'revert merge commit')"
        },
        "database_rollback": { 
          "type": "string",
          "description": "Database rollback SQL or strategy"
        },
        "recovery_steps": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step-by-step recovery procedure"
        }
      }
    },
    "definition_of_done": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Checklist items for completion"
    },
    "traceability": {
      "type": "object",
      "description": "V10.7 traceability fields for audit and tracking",
      "properties": {
        "epic_id": {
          "type": "string",
          "pattern": "^EPIC-[0-9]+$",
          "description": "Parent epic ID"
        },
        "feature_id": {
          "type": "string",
          "description": "Feature ID within epic"
        },
        "linear_id": {
          "type": "string",
          "description": "Linear issue ID if applicable"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Story creation timestamp"
        },
        "created_by": {
          "type": "string",
          "description": "Creator (human or agent ID)"
        },
        "approved_by": {
          "type": "string",
          "description": "Approver (PM or CTO agent)"
        },
        "approved_at": {
          "type": "string",
          "format": "date-time",
          "description": "Approval timestamp"
        }
      }
    },
    "execution": {
      "type": "object",
      "description": "V10.7 execution tracking fields",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["draft", "approved", "assigned", "in_progress", "blocked", "testing", "review", "done", "cancelled"],
          "default": "draft"
        },
        "current_gate": {
          "type": "integer",
          "minimum": 0,
          "maximum": 7,
          "description": "Current gate in 8-gate system"
        },
        "assigned_agent": {
          "type": "string",
          "description": "Currently assigned agent ID"
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "branch_name": {
          "type": "string",
          "pattern": "^feature/[A-Z]+-[A-Z]+-[0-9]{3}",
          "description": "Git branch name"
        },
        "worktree_path": {
          "type": "string",
          "description": "Git worktree path for isolation"
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "V10.7 metrics tracking",
      "properties": {
        "tokens_used": {
          "type": "integer",
          "description": "Total tokens consumed"
        },
        "iterations": {
          "type": "integer",
          "description": "Number of agent iterations"
        },
        "duration_minutes": {
          "type": "number",
          "description": "Total execution time"
        },
        "test_coverage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Achieved test coverage"
        },
        "quality_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "QA quality score"
        }
      }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "measurability_patterns": {
      "description": "Patterns that indicate measurable criteria (from linter)",
      "examples": [
        "within 200ms",
        ">= 80%",
        "return 200",
        "status: 400",
        "maximum 10",
        "at least 3 items",
        "24h expiry"
      ]
    },
    "action_verbs": {
      "description": "Valid action verbs for title pattern",
      "enum": [
        "Create", "Add", "Update", "Fix", "Remove", "Implement",
        "Configure", "Enable", "Disable", "Refactor", "Migrate",
        "Build", "Setup", "Initialize", "Delete", "Modify"
      ]
    },
    "ears_keywords": {
      "description": "EARS requirement keywords",
      "enum": ["SHALL", "SHOULD", "MAY", "MUST", "WHEN", "WHILE", "IF", "THEN", "GIVEN"]
    }
  }
}
